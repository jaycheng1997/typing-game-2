<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>打字風暴 - 行動優化版</title>
    <style>
        :root {
            --primary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --bg: #1a1a2e;
            --card-bg: #16213e;
            --text: #ecf0f1;
            --ai-accent: #a29bfe;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* 手機版頂部對齊，避免鍵盤遮擋 */
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            transition: background 0.2s ease;
            overflow-x: hidden;
        }

        @keyframes ultraShake {
            0% { transform: translate(0, 0) rotate(0deg); }
            10% { transform: translate(-3px, -1px) rotate(-1deg); }
            20% { transform: translate(-2px, 0px) rotate(1deg); }
            30% { transform: translate(2px, 1px) rotate(0deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        .ultra-shake { animation: ultraShake 0.15s ease-in-out; }

        .container {
            text-align: center;
            background: var(--card-bg);
            padding: 1.5rem 1rem;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 500px;
            position: relative;
            z-index: 10;
            border: 1px solid rgba(255,255,255,0.05);
            margin-top: 20px;
        }

        h1 { margin: 0 0 10px; font-size: 1.5rem; color: var(--primary); }

        #ai-motivate {
            font-size: 0.85rem;
            color: var(--ai-accent);
            margin-bottom: 15px;
            min-height: 2.4rem; /* 兩行高度 */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 10px;
        }

        .selection-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .option-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            align-items: center;
        }

        .label-text { font-size: 0.75rem; color: #888; width: 100%; margin-bottom: 4px; }

        .btn-select {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            color: white;
            padding: 10px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            flex: 1;
            min-width: 80px;
        }

        .difficulty-btn[data-diff="easy"].active { background: var(--success); border-color: var(--success); }
        .difficulty-btn[data-diff="medium"].active { background: var(--primary); border-color: var(--primary); }
        .difficulty-btn[data-diff="hard"].active { background: var(--danger); border-color: var(--danger); }
        
        .time-btn.active { background: #444; border-color: #777; }

        #word-area {
            position: relative;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        #word-display {
            font-size: 2.2rem; /* 手機版稍縮小 */
            font-weight: 900;
            word-break: break-all;
            position: relative;
            z-index: 5;
            transition: color 0.1s;
        }

        .word-impact { animation: impact 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        @keyframes impact {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }

        .particle { position: absolute; pointer-events: none; z-index: 4; border-radius: 50%; }

        #input-field {
            font-size: 1.4rem;
            padding: 15px;
            border-radius: 15px;
            border: 2px solid rgba(255,255,255,0.1);
            outline: none;
            width: 100%;
            box-sizing: border-box;
            text-align: center;
            background: #fff;
            color: #1a1a2e;
            margin-bottom: 10px;
            /* 防止 iOS 自動放大 */
            font-size: 16px; 
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .stat-item { font-size: 0.75rem; color: #888; }
        .stat-item span { display: block; font-size: 1.4rem; font-weight: 800; color: var(--text); margin-top: 2px; }

        #start-btn {
            margin-top: 15px;
            padding: 18px;
            font-size: 1.1rem;
            cursor: pointer;
            border: none;
            border-radius: 15px;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            font-weight: 800;
            width: 100%;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }

        #start-btn:active { transform: scale(0.98); }
        #start-btn:disabled { background: #455a64; box-shadow: none; opacity: 0.6; }

        .combo-badge {
            position: absolute;
            right: 0px;
            top: -15px;
            background: #f1c40f;
            color: #000;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 900;
            font-size: 0.8rem;
            transform: rotate(10deg);
            display: none;
            z-index: 20;
        }

        /* 針對小螢幕微調 */
        @media (max-height: 600px) {
            .container { margin-top: 5px; padding: 1rem; }
            #ai-motivate { margin-bottom: 5px; min-height: 1rem; }
            #word-area { height: 60px; }
            #word-display { font-size: 1.8rem; }
        }
    </style>
</head>
<body>

<div class="container" id="game-container">
    <div class="combo-badge" id="combo-badge">連擊 x0</div>
    <h1>⌨️ 打字風暴</h1>
    <div id="ai-motivate">準備好挑戰你的指尖速度嗎？</div>

    <div class="selection-group" id="settings">
        <div class="option-row">
            <span class="label-text">選擇難度</span>
            <button class="btn-select difficulty-btn active" data-diff="easy">簡單</button>
            <button class="btn-select difficulty-btn" data-diff="medium">中等</button>
            <button class="btn-select difficulty-btn" data-diff="hard">困難</button>
        </div>
        <div class="option-row">
            <span class="label-text">挑戰時長</span>
            <button class="btn-select time-btn active" data-time="60">60s</button>
            <button class="btn-select time-btn" data-time="180">180s</button>
            <button class="btn-select time-btn" data-time="10">測試</button>
        </div>
    </div>

    <div id="word-area">
        <div id="word-display">START</div>
    </div>
    
    <input type="text" id="input-field" placeholder="點擊下方按鈕開始..." disabled autocomplete="off" autocapitalize="none" spellcheck="false">
    
    <div class="stats-grid">
        <div class="stat-item">剩餘時間<span id="time-left">60</span></div>
        <div class="stat-item">擊破數<span id="score">0</span></div>
    </div>

    <button id="start-btn">開始任務</button>
</div>

<script>
    const apiKey = ""; 
    const rawWords = [
        // --- 簡單 (3-5 字) ---
        'cat', 'dog', 'run', 'fast', 'blue', 'fire', 'code', 'data', 'web', 'link', 'user', 'base', 'app', 'icon', 'task',
        'key', 'node', 'java', 'html', 'css', 'git', 'api', 'json', 'box', 'grid', 'flex', 'font', 'text', 'size', 'bold',
        'list', 'item', 'path', 'url', 'map', 'set', 'true', 'null', 'void', 'sync', 'wait', 'call', 'push', 'pop',
        'loop', 'char', 'byte', 'file', 'save', 'edit', 'view', 'help', 'menu', 'page', 'site', 'mode', 'dark', 'show', 'hide',
        'move', 'drag', 'drop', 'type', 'scan', 'host', 'port', 'ping', 'root', 'tree', 'leaf', 'back', 'step', 'main', 'test',

        // --- 中等 (7-11 字) ---
        'algorithm', 'blockchain', 'encryption', 'framework', 'interface', 'kubernetes', 'lighthouse', 'javascript', 
        'performance', 'responsive', 'serverless', 'typescript', 'virtualize', 'connection', 'deployment', 'middleware',
        'repository', 'expression', 'controller', 'navigation', 'production', 'collection', 'environment', 'monitoring',
        'validation', 'component', 'observable', 'dependency', 'constructor', 'inheritance', 'polymorphism', 'encapsulation',
        'abstraction', 'asynchronous', 'breadcrumb', 'breakpoint', 'cacheability', 'certificate', 'destination', 'dictionary',
        'distributed', 'engineering', 'exponential', 'filesystem', 'identifier', 'integration', 'maintenance', 'placeholder',
        'prototyping', 'refactoring', 'reliability', 'scalability', 'spreadsheet', 'transaction', 'verification', 'workstation',

        // --- 困難 (12 字以上) ---
        'cybersecurity', 'intelligence', 'nanotechnology', 'optimization', 'virtualization', 'synchronization', 
        'authentication', 'infrastructure', 'multiprocessing', 'microservices', 'supercomputer', 'cryptography',
        'reproducibility', 'sustainability', 'interoperability', 'standardization', 'transformation', 'classification',
        'identification', 'documentation', 'implementation', 'interpretation', 'parallelization', 'decentralization',
        'backpropagation', 'bioinformatics', 'bioengineering', 'characterization', 'computability', 'conceptualization',
        'differentiation', 'generalization', 'incompatibility', 'individualization', 'industrialization', 'marginalization',
        'neutralization', 'operationalization', 'overparameterization', 'professionalization', 'reconceptualization', 'recommendation',
        'responsiveness', 'telecommunication', 'thoroughness', 'vulnerability', 'weatherproofing', 'unpredictability'
    ];
    
    let currentWord = '';
    let score = 0;
    let combo = 0;
    let selectedDuration = 60;
    let selectedDifficulty = 'easy';
    let timeLeft = 0;
    let isPlaying = false;
    let timer;

    let currentRoundWords = [];
    let currentWordIndex = 0;

    const body = document.body;
    const wordArea = document.getElementById('word-area');
    const wordDisplay = document.getElementById('word-display');
    const inputField = document.getElementById('input-field');
    const timeLeftDisplay = document.getElementById('time-left');
    const scoreDisplay = document.getElementById('score');
    const startBtn = document.getElementById('start-btn');
    const comboBadge = document.getElementById('combo-badge');
    const aiMotivate = document.getElementById('ai-motivate');
    const settings = document.getElementById('settings');

    // 行動端點擊優化
    document.querySelectorAll('.difficulty-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            if (isPlaying) return;
            document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedDifficulty = btn.dataset.diff;
        });
    });

    document.querySelectorAll('.time-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            if (isPlaying) return;
            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedDuration = parseInt(btn.dataset.time);
            timeLeftDisplay.innerText = selectedDuration;
        });
    });

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function getFilteredWords() {
        return rawWords.filter(w => {
            if (selectedDifficulty === 'easy') return w.length >= 3 && w.length <= 5;
            if (selectedDifficulty === 'medium') return w.length >= 7 && w.length <= 11;
            if (selectedDifficulty === 'hard') return w.length >= 12;
            return true;
        });
    }

    function prepareRoundWords() {
        const filtered = getFilteredWords();
        currentRoundWords = shuffleArray([...filtered]);
        currentWordIndex = 0;
    }

    async function callGemini(prompt, systemInstruction = "") {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: systemInstruction }] }
                })
            });
            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "繼續保持！";
        } catch (e) { return "衝啊！"; }
    }

    async function updateAIMotivation() {
        if (!isPlaying) return;
        const prompt = `玩家在 ${selectedDifficulty} 難度下擊破 ${score} 字，連擊 ${combo}。給一句 15 字內的戰鬥鼓勵。`;
        const msg = await callGemini(prompt, "你是熱血指揮官。");
        aiMotivate.innerText = msg;
    }

    function startGame() {
        if (isPlaying) return;
        isPlaying = true;
        score = 0; combo = 0;
        timeLeft = selectedDuration;
        scoreDisplay.innerText = score;
        timeLeftDisplay.innerText = timeLeft;
        
        inputField.disabled = false;
        inputField.value = '';
        inputField.placeholder = "在此輸入單字...";
        
        // 延遲焦點，確保鍵盤在某些行動瀏覽器上能正確彈出
        setTimeout(() => inputField.focus(), 100);
        
        startBtn.disabled = true;
        startBtn.innerText = '任務執行中';
        settings.style.opacity = "0.5";
        settings.style.pointerEvents = "none";
        
        prepareRoundWords();
        showNextWord();
        
        timer = setInterval(countDown, 1000);
        updateAIMotivation();
    }

    function showNextWord() {
        if (currentWordIndex >= currentRoundWords.length) {
            prepareRoundWords();
        }
        currentWord = currentRoundWords[currentWordIndex];
        currentWordIndex++;
        wordDisplay.innerText = currentWord;
        wordDisplay.style.color = 'white';
        wordDisplay.classList.remove('word-impact');
    }

    function triggerMegaEffects() {
        body.classList.remove('ultra-shake');
        void body.offsetWidth; 
        body.classList.add('ultra-shake');
        wordDisplay.classList.add('word-impact');
        createExplosion();
        
        const originalBg = body.style.background;
        body.style.background = '#2ecc71';
        setTimeout(() => body.style.background = originalBg, 80);
        
        combo++;
        if (combo >= 3) {
            comboBadge.style.display = 'block';
            comboBadge.innerText = `連擊 x${combo}`;
        }
    }

    function createExplosion() {
        const rect = wordDisplay.getBoundingClientRect();
        const containerRect = document.getElementById('game-container').getBoundingClientRect();
        
        for (let i = 0; i < 12; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            const size = Math.random() * 6 + 3;
            p.style.width = p.style.height = `${size}px`;
            p.style.backgroundColor = ['#00f2fe', '#f1c40f', '#e74c3c'][Math.floor(Math.random()*3)];
            
            // 相對於 word-area 的位置
            p.style.left = `50%`; 
            p.style.top = `50%`;
            wordArea.appendChild(p);
            
            const a = Math.random() * Math.PI * 2;
            const v = 3 + Math.random() * 6;
            let px = 0, py = 0, op = 1;
            
            const move = () => {
                px += Math.cos(a)*v; py += Math.sin(a)*v + 0.1; op -= 0.03;
                p.style.transform = `translate(${px}px, ${py}px) scale(${op})`;
                p.style.opacity = op;
                if (op > 0) requestAnimationFrame(move); else p.remove();
            };
            requestAnimationFrame(move);
        }
    }

    inputField.addEventListener('input', () => {
        const val = inputField.value.trim().toLowerCase(); // 手機輸入可能首字母大寫，統一轉小寫
        const target = currentWord.toLowerCase();

        if (target.startsWith(val)) {
            wordDisplay.style.color = '#2ecc71';
        } else {
            wordDisplay.style.color = '#e74c3c';
            if (val.length > 0) {
                combo = 0; 
                comboBadge.style.display = 'none';
            }
        }
        
        if (val === target) {
            score++;
            scoreDisplay.innerText = score;
            inputField.value = '';
            triggerMegaEffects();
            showNextWord();
            
            if (score % 5 === 0) updateAIMotivation();
        }
    });

    function countDown() {
        if (timeLeft > 0) {
            timeLeft--;
            timeLeftDisplay.innerText = timeLeft;
            if (timeLeft <= 5) timeLeftDisplay.style.color = 'var(--danger)';
            else timeLeftDisplay.style.color = 'white';
        } else {
            gameOver();
        }
    }

    function gameOver() {
        isPlaying = false;
        clearInterval(timer);
        inputField.disabled = true;
        inputField.placeholder = "時間到！";
        startBtn.disabled = false;
        startBtn.innerText = '再次挑戰';
        settings.style.opacity = "1";
        settings.style.pointerEvents = "all";
        comboBadge.style.display = 'none';
        wordDisplay.innerText = 'FINISH!';
        wordDisplay.style.color = 'var(--warning)';
        aiMotivate.innerText = `戰果：擊破 ${score} 個單字！`;
    }

    // 點擊開始
    startBtn.addEventListener('click', startGame);

    // 處理虛擬鍵盤縮放問題
    window.addEventListener('resize', () => {
        if (document.activeElement.tagName === 'INPUT') {
            document.activeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });
</script>

</body>
</html>